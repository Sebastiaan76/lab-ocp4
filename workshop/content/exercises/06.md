In this lab you will provision an AWS Relational Database Service (RDS) instance and configure your application to use it.  Amazon RDS makes it easy to set up, operate, and scale MySQL deployments in the cloud. 

Using the ``AWS Broker``, which is configured and running on this OpenShift cluster, provision an AWS RDS MySQL service.  Connect the MySQL database to the application and test it. 

Go to the [Developer Catalog](%console_url%/catalog/ns/%project_namespace%). You will see many technologies which can be used.  One of them is the RDS Service.  In the search box, enter ``rds``.  You will see the ``Amazon RDS for MySQL`` service class.  Click on this RDS Service Class to read information about this service.  Then click on the ``Create Service Instance``  button to view all of the parameters that can be used to define the MySQL instance.  The most important options being:

1. Service Instance Name
1. DB Instance Class
1. Master User Password
1. DBName
1. StorageEncrypted 
1. Publicly Accessible
1. Master Username

 - Please ``DO NOT`` fill in this form and click on the ``Create`` button!  Instead, we will be using the ``svcat`` command from now on to work with the AWS Broker.

Now, provision an instance of MySQL RDS using the ``svcat`` command: 

```execute
svcat provision mysql --class rdsmysql --plan custom  \
   -p PubliclyAccessible=true \
   -p DBName=vote \
   -p AccessCidr=0.0.0.0/0 \
   -p MasterUsername=user \
   -p MasterUserPassword=ocpWorkshop2019 \
   -p MultiAZ=false \
   -p DBInstanceClass=db.m4.large \
   -p AutoMinorVersionUpgrade=false \
   -p PortNumber=13306 \
   -p BackupRetentionPeriod=0 \
   -p VpcId=vpc-03a00c0e08cc9bec3 
```

As specified in the above command, an instance of MySQL will be created with an instance type of ``db.m4.large`` and will be accessible publicly. 

Check the status of the RDS instance:

```execute
svcat get instances
```

Wait for the instance _status_ to be ``Ready``. 

Bind the new database with the application by creating a secret containing the access credentials (host, username, password...):

```execute
svcat bind mysql --name mysql-binding --secret-name mysql-secret
```

Check the RDS bindings:

```execute
svcat get bindings
```

The binding creates a secret containing the database's access credentials (host, username, password ...)

View the secret:

```execute
oc describe secret mysql-secret 
```
 - ``Note that if you see the error ``not found`` the secret has not been created yet.  This most likely means the RDS instance has not finished provisioning.`` 

Now, connect the app to the production database by injecting the credentials into the application.

Add the credentials into the application by importing them from the secret:

```execute
oc set env --from=secret/mysql-secret dc/vote-app
```

Check the environment variables have ben properly set:

```execute
oc set env dc/vote-app --list
```

The above command should show the .... FIXME


Ensure the application is still working:

```execute 
curl -s http://vote-app-%project_namespace%.%cluster_subdomain%/ | grep "<title>"
```

Test the application in a browser:

[Open the Vote Application](http://vote-app-%project_namespace%.%cluster_subdomain%/)

 - ``Note that your neighbour should also be able to access your application and submit a vote.`` 

Now, deprovision the production database. 

First, the binding needs to be removed.  This means removing the credentials and the secret.

```execute
svcat unbind --name mysql-binding
```

... and then the MySQL service can be deprovisioned:

```execute
svcat deprovision mysql 
```

The MySQL instance will be removed and takes about 2 to 3 minutes.  